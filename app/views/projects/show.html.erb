
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha512-mSYUmp1HYZDFaVKK//63EcZq4iFWFjxSL+Z3T/aCt4IO9Cejm03q3NKKYN6pFQzY0SBOr8h+eCIAZHPXcpZaNw==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/css/bootstrap-timepicker.min.css" integrity="sha512-/Ae8qSd9X8ajHk6Zty0m8yfnKJPlelk42HTJjOHDWs1Tjr41RfsSkceZ/8yyJGLkxALGMIYd5L2oGemy/x1PLg==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/js/bootstrap-timepicker.min.js" integrity="sha512-2xXe2z/uA+2SyT/sTSt9Uq4jDKsT0lV4evd3eoE/oxKih8DSAsOF6LUb+ncafMJPAimWAXdu9W+yMXGrCVOzQA==" crossorigin="anonymous"></script>
<script type="text/javascript">
    $('#daily-scrum-time-input').timepicker();
    $('#sprint-review-time-input').timepicker();
</script>

<% reflex_variables = { backbone_document: @backbone_document, search_information: @search_information, reflex_pages: @reflex_pages, project_edited: @project_edited } %>





<h1 id="show-project-header"><%= @project.project_name %></h1>



<% if @weaknesses != [] %>
    <div id="backbone-weaknesses">
        <% @weaknesses.each do |w| %>
            <p class="weakness"><%= w %></p>
        <% end %>
    </div>
<% end %>



<% @reflex_pages['buttons'].each do |button, bool| %>
    <% if !@reflex_pages['buttons'][button] %>
        <%= button_tag(button, id: "#{button}-button", value: button, data: { reflex: 'click->EditProject#show_page', vars: reflex_variables }) %>
    <% else %>
        <%= button_tag(button, id: "#{button}-button", value: button, disabled: true) %>
    <% end %>
<% end %>



<% if @reflex_pages['scrum'] %>


    <h2 id="scrum-header">Scrum</h2>


    <h4 id="sprint-header">Sprint Schedule<h4>
    <% @backbone_document['sprint'].each do |item, time| %>
        <% datetime = { 'date' => true, 'time' => false } %>
        <% item_css_formatted = item.gsub('_', '-') %>
        <% item_copy_formatted = item.gsub('_', ' ') %>
        <% if item.split('_').size > 1 %>
            <% if item.split('_')[0] != 'sprint' %>
                <% datetime['date'] = false %>
            <% end %>
            <% datetime['time'] = true %>
        <% end %>
        <% if time != '' %>
            <% if time.class == String %>
                <% time = Time.parse(time) %>
                <%# date_parts = team.split('T')[0].split('-') %>
                <%# time = Time.new(date_parts[0], date_parts[1], date_parts[2]) %>
            <% end %>
            <% if item == 'daily_scrum'%>
                <% time = time.strftime("%r") %>
            <% elsif item.split('_').size < 2 %>
                <% time = time.strftime("%A, %B %d, %Y") %>
            <% else %>
                <% time = time.strftime("%A, %B %d, %Y, %r") %>
            <% end %>
        <% else %>
            <% time = 'not set' %>
        <% end %>
        <%= content_tag(:p, "#{item_copy_formatted}: #{time}", id: "sprint-#{item_css_formatted}") %>
        <% if @scrum_editing_privileges %>
            <% if !@reflex_pages["#{item_copy_formatted}"] %>
                <%= button_tag('edit', id: "change-sprint-#{item_css_formatted}", value: item_copy_formatted, data: { reflex: 'click->EditProject#toggle_page_item', vars: reflex_variables }) %>
            <% else %>
                <%= button_tag('done', id: "change-sprint-#{item_css_formatted}", value: item_copy_formatted, data: { reflex: 'click->EditProject#toggle_page_item', vars: reflex_variables }) %>
                <% if datetime['date'] %>
                    <div id="<%= item_css_formatted %>-datepicker" class="input-group date bootstrap-datepicker datepicker" data-provide="datepicker">
                        <%= render 'shared/datepicker' %>
                        <%= text_field_tag("#{item_css_formatted}-date-input", nil, placeholder: "#{item_copy_formatted} date", id: "#{item_css_formatted}-date-input", type: 'text', data: { reflex: 'mouseover->EditProject#change_date', vars: reflex_variables, item: item }, :readonly => true) %>
                    </div>
                <% end %>
                <% if datetime['time'] %>
                    <div id="<%= item_css_formatted %>-timepicker" class="input-group time bootstrap-timepicker timepicker">
                        <%= text_field_tag("#{item_css_formatted}-time-input", nil, placeholder: "#{item_copy_formatted} time", id: "#{item_css_formatted}-time-input", type: 'text', data: { provide: 'timepicker', reflex: 'keyup->EditProject#change_time', vars: reflex_variables, item: item }) %>
                    </div>
                <% end %>
            <% end %>
        <% end %>
    <% end %>


<% end %>



<% if @reflex_pages['team'] %>


    <h2 id="team-header">Team</h2>


    <h4 id="team-leadership-header">Team leadership</h4>
    <% @backbone_document['leaders'].each do |role, user| %>
        <% role_css_formatted = role.gsub('_', '-') %>
        <% role_copy_formatted = role.gsub('_', ' ') %>
        <% profile = Profile.find_by(user_id: user.first) %>
        <% user_information = profile.user_information %>
        <%= content_tag(:p, "#{role_copy_formatted}: ", id: "#{role_css_formatted}-#{user_information['first_name'].gsub(' ', '')}-#{user_information['last_name'].gsub(' ', '')}") %>
        <%= link_to("#{user_information['first_name']} #{user_information['last_name']}", profile_path(profile.id)) %>
        <% if @owner_editing_privileges %>
            <% if !@reflex_pages["#{role_copy_formatted}"] %>
                <%= button_tag('edit', id: "change-#{role_css_formatted}", value: role_copy_formatted, data: { reflex: 'click->EditProject#toggle_page_item', vars: reflex_variables }) %>
            <% else %>
                <%= button_tag('done', id: "change-#{role_css_formatted}", value: role_copy_formatted, data: { reflex: 'click->EditProject#toggle_page_item', vars: reflex_variables }) %>
                <%= text_field_tag("search-for-#{role_css_formatted}", nil, placeholder: 'search', id: "#{role_css_formatted}-search", data: { reflex: 'keyup->EditProject#edit_search_query', vars: reflex_variables }) %>
                <% Profile.all_containing(@search_information).each do |p| %>
                    <% if p != profile %>
                        <% user_info = p.user_information %>
                        <ul>
                            <li>
                                <%= link_to("#{user_info['first_name']} #{user_info['last_name']}", profile_path(p.id)) %>
                                <%= content_tag(:p, user_info['user_bio']) %>
                                <%= button_tag("make #{user_info['first_name']} #{user_info['last_name']} #{role_copy_formatted}", id: "make-#{user_info['first_name'].gsub(' ', '')}-#{user_info['last_name'].gsub(' ', '')}-#{role_css_formatted}", data: { reflex: 'click->EditProject#change_leader_role', vars: reflex_variables, role: role, user_id: p.user_id }) %>
                            </li>
                        </ul>
                    <% end %>
                <% end %>
            <% end %>
        <% end %>
    <% end %>

    <h4 id="development-team-header">Development team</h4>
    <% @backbone_document['development_team'].each do |subset, members| %>
        <% subset_css_formatted = subset.gsub('_', '-') %>
        <% subset_copy_formatted = subset.gsub('_', ' ') %>
        <h5 id="development-subset-<%= subset_css_formatted %>"><%= subset_copy_formatted %></h5>
        <% if !@owner_editing_privileges %>
            <% members.each do |user_id| %>
                <% profile = Profile.find_by(user_id: user_id) %>
                <% user_info = profile.user_information %>
                <ul>
                    <li>
                        <%= link_to("#{user_info['first_name']} #{user_info['last_name']}", profile_path(profile.id)) %>
                    </li>
                </ul>
            <% end %>
        <% else %>
            <% if !@reflex_pages["#{subset_copy_formatted}"] %>
                <%= button_tag("edit", id: "edit-#{subset_css_formatted}", value: subset_copy_formatted, data: { reflex: 'click->EditProject#toggle_page_item', vars: reflex_variables }) %>
                <% members.each do |user_id| %>
                    <% profile = Profile.find_by(user_id: user_id) %>
                    <% user_info = profile.user_information %>
                    <ul>
                        <li>
                            <%= link_to("#{user_info['first_name']} #{user_info['last_name']}", profile_path(profile.id)) %>
                        </li>
                    </ul>
                <% end %>
            <% else %>
                <%= button_tag("done", id: "edit-#{subset_css_formatted}", value: subset_copy_formatted, data: { reflex: 'click->EditProject#toggle_page_item', vars: reflex_variables }) %>
                <% members.each do |user_id| %>
                    <% profile = Profile.find_by(user_id: user_id) %>
                    <% user_info = profile.user_information %>
                    <ul>
                        <li>
                            <%= link_to("#{user_info['first_name']} #{user_info['last_name']}", profile_path(profile.id)) %>
                            <%= content_tag(:p, user_info['user_bio']) %>
                            <%= button_tag("remove #{user_info['first_name']} #{user_info['last_name']} from #{subset_copy_formatted}", id: "remove-#{user_info['first_name'].gsub(' ', '')}-#{user_info['last_name'].gsub(' ', '')}-from-#{subset_css_formatted}", data: { reflex: 'click->EditProject#remove_user_from_subset', vars: reflex_variables, subset: subset, user_id: user_id }) %>
                        </li>
                    </ul>
                <% end %>
                <%= text_field_tag("search-for-#{subset_css_formatted}", nil, placeholder: 'search', id: "#{subset_css_formatted}-search", data: { reflex: 'keyup->EditProject#edit_search_query', vars: reflex_variables }) %>
                <% Profile.all_containing(@search_information).each do |p| %>
                    <% if !members.include?(p.user_id) %>
                        <% user_info = p.user_information %>
                        <ul>
                            <li>
                                <%= link_to("#{user_info['first_name']} #{user_info['last_name']}", profile_path(p.id)) %>
                                <%= content_tag(:p, user_info['user_bio']) %>
                                <%= button_tag("add #{user_info['first_name']} #{user_info['last_name']} to #{subset_copy_formatted}", id: "add-#{user_info['first_name'].gsub(' ', '')}-#{user_info['last_name'].gsub(' ', '')}-to-#{subset_css_formatted}", data: { reflex: 'click->EditProject#add_user_to_subset', vars: reflex_variables, subset: subset, user_id: p.user_id }) %>
                            </li>
                        </ul>
                    <% end %>
                <% end %>
            <% end %>
        <% end %>
    <% end %>

<% end %>




<% if @project_edited %>
    <%= form_for @project, :method => :PUT do |f| %>
        <%= f.hidden_field(:backbone_document, value: @backbone_document) %>
        <%= f.submit('save changes') %>
    <% end %>
<% end %>


<script type="text/javascript">
    // $(document).ready(function() {
        $('#daily-scrum-time-input').timepicker();
    // });
</script>